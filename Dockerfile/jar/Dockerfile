#FROM openjdk:8-jre-alpine   ã€ æ³¨ï¼šjreä¸­å¹¶æ²¡æœ‰æºå¸¦å·¥å…·æ–‡ä»¶ï¼Œä½†arthaséœ€è¦ä¾èµ–libåŒ…å’ŒbinåŒ…é‡Œé¢çš„åŒ…å’Œå·¥å…·ï¼Œarthaséœ€è¦jpså·¥å…·å’ŒlibåŒ…é‡Œçš„å†…å®¹ ã€‘
# ä½¿ç”¨è‡ªåˆ¶jdk
FROM registry.cn-hangzhou.aliyuncs.com/zhengqing/openjdk:8-jdk-alpine

# ç»´æŠ¤è€…ä¿¡æ¯
MAINTAINER zhengqingya

# æž„å»ºé•œåƒæ—¶ä¼ å‚æ•°æ®
ARG APP_NAME
ARG APP_PORT
ARG JAVA_OPTS

# è®¾ç½®çŽ¯å¢ƒå˜é‡-è¿è¡Œæ—¶ä¹Ÿå¯ä¼ å‚è¿›æ¥è€å“ˆ
ENV APP_NAME ${APP_NAME}
ENV APP_JAR ${APP_NAME}.jar
ENV APP_PORT ${APP_PORT}
ENV JAVA_OPTS ${JAVA_OPTS}
# -XX:+UseG1GC -Xms64m -Xmx64m -Xmn16m -XX:MetaspaceSize=100m -XX:MaxMetaspaceSize=100m -XX:MaxGCPauseMillis=200 -XX:ParallelGCThreads=8 -Ddefault.client.encoding=UTF-8 -Dfile.encoding=UTF-8 -Duser.language=Zh -Duser.region=CN -Dspring.profiles.active=xx -Dspring.cloud.nacos.discovery.server-addr=xx -Dspring.cloud.nacos.discovery.username=nacos -Dspring.cloud.nacos.discovery.password=nacos
# è¿œç¨‹è°ƒè¯•å‚æ•°ï¼š -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5001


# copy arthas
COPY --from=hengyunabc/arthas:latest /opt/arthas /opt/arthas


# æ·»åŠ jaråŒ…åˆ°å®¹å™¨ä¸­ -- tips: xx.jar å’Œ Dockerfile åœ¨åŒä¸€çº§
ADD ${APP_JAR} /home/
RUN sh -c 'touch /'

VOLUME /tmp

# å¯¹å¤–æš´æ¼çš„ç«¯å£å·
# [æ³¨ï¼šEXPOSEæŒ‡ä»¤åªæ˜¯å£°æ˜Žå®¹å™¨è¿è¡Œæ—¶æä¾›çš„æœåŠ¡ç«¯å£ï¼Œç»™è¯»è€…çœ‹æœ‰å“ªäº›ç«¯å£ï¼Œåœ¨è¿è¡Œæ—¶åªä¼šå¼€å¯ç¨‹åºè‡ªèº«çš„ç«¯å£ï¼ï¼]
EXPOSE ${APP_PORT}

# è®©ä½ å…ˆä¼‘æ¯3ç§’å†å¼€å§‹è¿è¡Œå§ðŸƒðŸƒðŸƒ
CMD echo "****** Start... " & \
    echo "****** APP_JAR: ${APP_JAR} " & \
    echo "****** APP_PORT: ${APP_PORT} " & \
    echo "****** JAVA_OPTS: ${JAVA_OPTS} " & \
    echo "****** ${APP_JAR} will run ..." & \
    sleep 3 & \
    echo "****** è¿è¡Œå‘½ä»¤ï¼šnohup java -jar ${JAVA_OPTS} /home/${APP_JAR} >> /home/${APP_NAME}.log 2>&1 &" & \
    nohup java -jar ${JAVA_OPTS} /home/${APP_JAR} >> /home/${APP_NAME}.log 2>&1 & \
    echo "****** æŸ¥çœ‹æ—¥å¿—..." & \
    tail -f /home/${APP_NAME}.log
